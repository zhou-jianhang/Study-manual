# 广州事业群-台账信息

### 1 账户信息

iNode:	liling@gkoa/liling1
安全客户端/espace: 77522313/Liling12@
云桌面：77522313/Liling1@@
云桌面地址：http://128.128.214.11/



共享文件：
ftp://128.128.171.48:210/



git仓库地址：128.194.225.4:3005



银校数据库：
jdbc:oracle:thin:@//128.196.236.19:11521/CLSXT0_CEN00003_22
账号密码：CLSCS_APP/clscs_app

![image-20210908093220898](D:\Documents\md\广州事业群-台账信息.assets\image-20210908093220898.png)







```shell
建融慧学服务器
host:128.196.189.98
port:22
root/password:clsvc/clsvc

*****多服务****
service-name:pl4   port:8101  account/password:clsvc/vlsvc
service-name:pl2   port:8103  account/password:clscs/Welc@me1


*****服务启停*****
cdplat进入目录
启停服务脚本：start_mSrv1.sh、stop_mSrv1.sh

*****日志排查*****
1、快捷命令cdl进入日志目录
2、目录下有logs、mc、nec、tranlog文件
3、报文发送出错进入nec文件，根据SYS_EVT_TRACE_ID排查日志【nec下日志分为err和out日志，err只输出错误日志，out输出全部日志】
4、grep '查询关键词' 文件名  可以定位具体内容
5、logs下主要存放的是中转站与后端的交互日志，以及中转站与前端的交互日志（standard_data）
```



### 2 交易流程

- 配置channel的tram.xml（配置返回给前端的数据）

- 将数据插入txn_conv、txn_code、txn_rout三个表，SVC_NM：可以找到对应服务的目录

  根据`chal_txn_cd`可以在txn_conv表中查到`PLAT_TXN_CODE`，根据PLAT_TXN_CODE可以在txn_rout表中查到`SVC_NM`

  根据SVC_NM可以找到**simple-service**或者**nec-service**下的目录包下的service.xml




### 3 交易详情

#### 3.1 银校外联接口文档说明

|    属性    |                             说明                             |              位置              |
| :--------: | :----------------------------------------------------------: | :----------------------------: |
|  交易编号  | 来源：自定义，根据银校常用的字符串P5开头，加商户提供的请求码来组成，例如：P5USR0308 | channel包下文件夹名称P5USR0308 |
| 后端交易号 |                  商户接口文档中提供的请求码                  |               —                |
|  请求报文  |                 商户接口文档中提供的请求参数                 |               —                |
|  响应报文  |                 商户接口文档中需求的响应参数                 |               —                |



#### 3.2 channel下的tran.xml文件说明

根据交易编号`CHNL_TXN_CD`找到epconf/channel/standard_xml/ 下以`CHNL_TXN_CD`值命名的文件

![image-20210913112240671](D:\Documents\md\广州事业群-台账信息.assets\image-20210913112240671.png)



几个比较重要的参数说明：

```xml
<tran name="交易编号" service-name="交易编号+000"></tran>
<response>
    <default-package-mode mode="standard_response" />
    <pack-config>
        <pack-head>
            <tran_response/>
        </pack-head>
        <!-- 响应报文的属性，存在一些固定的属性，比如msg,code -->
        <pack-body>
            <field name="xxx"></field>
		</pack-body>
        
        </pack-config>
</response>
```

#### 3.3 路由表说明



```sql
#txn_conv
insert into TXN_CONV(CHNL_ADAP_ID,CHNL_TXN_CD,CHNL_ASS_NO,TXN_DSC,CHNL_ID,PLAT_TXN_CODE,TXN_STYL,TXN_TP,TXN_SUBTP,STRIK_FLG,CONV_RULS) values ('standard','交易编号','00','交易编号','60','交易编号+000','','','','0','');


#txn_code
insert into TXN_CODE(PLAT_TXN_CODE,TXN_NM,ITCD_NO,REC_FLOW_FLG,ASS_FLOW_FLG,OPCL_FLG) values('交易编号+000','交易编号','99999999999','','','0');


#txn_rout
insert into TXN_ROUT(PLAT_TXN_CODE,SVC_NM,OPER_TEAM) values('交易编号+000','自定义','');


----------------------------------------------------------------------------------------------------

select * from TXN_CONV WHERE CHNL_TXN_CD='P5FHTS001';

select * from TXN_ROUT WHERE PLAT_TXN_CODE='P5FHTS001000';

select * from TXN_CODE WHERE PLAT_TXN_CODE = 'P5FHTS001000';

```



#### 3.4 服务说明

##### 3.4.1 Simple-service（简单服务）and Service.xml说明

根据`SVC_NM`在简单服务目录中找到`SVC_NM`对应的文件目录

###### 3.4.1.1 service.xml



```xml
<simple-service name="SVC_NM的值" desc="Text">
    <service name="SVC_NM的值" object-name="wywl:SVC_NM的值">
        <before>
            <mapping>
                <item name="TX_CODE">SVC_NM的值</item>
                <item name="REQUEST_SN">substr(XXX...)</item>
            </mapping>
        </before>
        
        <after>
            <on-success/>
            <on-error/>
        </after>
    </service>
</simple-service>
```

`object-name`:冒号前为global中的XXX-package-config.xml的前缀XXX,例如：wywl-package-config.xml

###### 3.4.1.2 xxx-package-config.xml

```xml
<xxx-package-config>
	<head-fields></head-fields>
    <package trid="SVC_NM的值" cust="xxx(例如：wywl)，代表的应该是同一组的标识">
        <!-- 对应交易中的请求报文属性 -->
        <pack-field name="" required="true/false"/>
        <pack-field name="" required="true/false"/>
    </package>
</xxx-package-config>
```



##### 3.4.2 Nec-service（复杂服务）

###### 3.4.2.1 service.xml

```xml
<nec-service name="SVC_NM的值" class="复杂类处理路径" desc="描述"></nec-service>
```

`class的类路径指src/com/ccb/p1svc/service/下的xxx.java`文件，在该类中是处理复杂服务的逻辑

###### 3.4.2.2 xxx.java

复杂服务逻辑处理文件，文件出现乱码需要把idea中又下角的文件编码方式改为GBK

一些常用的类和方法：



|     名称      | 类型 |        作用        |
| :-----------: | :--: | :----------------: |
| ServiceResult |  类  | excute方法的返回类 |
| CompositeData |  类  |        封装        |
|               |      |                    |







```java
// ServiceResutl 返回对象
// CompositeData 封装请求对象

// 获取的outadapter_mod是什么？
String outadapter_mod =com.ccb.eframework.util.NBUtil.getDestCode("OUTADAPTER_MOD",shl_id);

// --------------------可以封装成一个方法----------------------
// 根据服务名获取服务
Service service=ServiceManagerFactory.getServiceManager().getService('服务名');
while(service instanceof ServiceProxy){
    service=((ServiceProxy) service).getService();
}

// 通过服务执行请求
resutl=service.execute(request);

//--------------------------------------------


// 响应状态码
String retcode=result.getOutput().getField("retcode");
```

收集对应字段的对应数据表的字段，即属性间的对应关系

